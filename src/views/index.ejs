<!DOCTYPE html>
<html lang="ko">
  <head>
    <% include ./templates/head %>
  </head>
  <body>
    <% include ./templates/header %>

    <section class="container">
      <table>
        <colgroup>
          <col style="width: 100px" />
          <col style="width: 100px" />
          <col style="width: 100px" />
          <col style="width: 200px" />
          <col style="width: 200px" />
          <col />
          <col style="width: 400px" />
        </colgroup>
        <thead>
          <tr>
            <th style="text-align: center">좋아요</th>
            <th style="text-align: center">싫어요</th>
            <th style="text-align: center">댓글</th>
            <th>가게 이름</th>
            <th>추천 메뉴</th>
            <th>설명</th>
            <th>한마디 / 관련 링크</th>
          </tr>
        </thead>
        <tbody>
          <% lunches.forEach(function(lunch) { %>
          <tr>
            <td style="text-align: center">
              <% if (lunch.id) { %>
              <button type="button" class="btn-like btn-like-dislike" data-lunch-id="<%=lunch.id%>">
                <i>👍🏻</i> <span id="lunch-like-<%=lunch.id%>"><%= lunch.like %></span>
              </button>
              <% } %>
            </td>
            <td style="text-align: center">
              <% if (lunch.id) { %>
              <button type="button" class="btn-dislike btn-like-dislike" data-lunch-id="<%=lunch.id%>">
                <i>👎🏻</i> <span id="lunch-dislike-<%=lunch.id%>"><%= lunch.dislike %></span>
              </button>
              <% } %>
            </td>
            <td style="text-align: center">
              <% if (lunch.id) { %>
              <button type="button" class="btn-comments" data-lunch-id="<%=lunch.id%>">
                <img src="/img/comment.png" alt="comments" /> <span><%=lunch.comments.length%></span>
              </button>
              <% } %>
            </td>
            <td><%= lunch.placeName %></td>
            <td><%= lunch.recommend %></td>
            <td><%= lunch.content %></td>
            <td>
              <% if (lunch.urlType === 'link') { %>
              <a class="lunch-link" href="<%= lunch.url %>" target="_blank">링크</a>
              <% } else if (lunch.urlType === 'image') { %>
              <a class="lunch-link" href="<%= lunch.url %>" target="_blank">
                <img class="lunch-image" src="<%= lunch.url %>" alt="이미지" />
              </a>
              <% } else { %> <%= lunch.url %> <% } %>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </section>

    <div id="modal-container">
      <div class="modal-background">
        <div id="modal-content" class="modal">
          <form id="comment-form">
              <% if (user) { %>
                <div class="comment-form">
                <img class="avatar" src="<%=user.profileImage%>" alt="avatar" />
                <textarea name="content" class="content"></textarea>
                <input name="id" type="hidden" value="" />
                <button type="submit" class="comment-btn-submit">
                  등록
                </button>
              <% } else { %>
                <div class="comment-form">
                <img class="avatar" src="/img/blank.jpg" alt="avatar" />
                <textarea name="content" class="content" disabled>로그인 하시면 댓글을 달 수 있어요.</textarea>
                <input name="id" type="hidden" value="" />
                <button type="submit" class="comment-btn-disabled" disabled>
                  등록
                </button>
              <% } %>
              </div>
          </form>
          <ul id="comment-list" class="comment-list"></ul>
        </div>
      </div>
    </div>

    <script>
      (function() {
        var loggedUserId = '<%=user ? user.id : "" %>';
        var $commentForm = $('#comment-form');
        var $commentList = $('#comment-list');

        function initComments(id) {
          $commentForm[0].reset();
          $commentForm.find('[name="id"]').val(id);
          $commentList.html('<li class="loading"><img src="/img/loading.gif" alt="loading" /></li>');
          $.ajax({
            url: '/api/lunches/' + id + '/comments',
            type: 'GET'
          })
            .done(function(data) {
              if (data.success) {
                const comments = _.map(data.comments, function(comment) {
                  var avatar = '<img class="avatar" src="' + comment.author.profileImage + '" alt="avatar" />';
                  var name = '<span class="name">' + comment.author.name + '</span>';
                  var content = '<p class="comment">' + comment.content.replace(/\n/, '<br>') + '</p>';
                  var createdAt = '<span class="create-date">' + dateFns.format(new Date(comment.createdAt), 'YYYY/MM/DD HH:mm:ss') + '</span>';
                  var btnRemove = '';
                  if (+loggedUserId === comment.author.id) {
                    btnRemove = '<button class="btn-remove" type="button" data-lunch-id="' + id + '" data-comment-id="' + comment.id + '">삭제</button>'
                  }
                  var left = '<div class="left">' + avatar + name + content + '</div>';
                  var right = '<div class="right">' + createdAt+ btnRemove + '</div>';
                  return '<li>' + left + right + '</li>';
                }).join('');
                $commentList.html(
                  data.comments.length ? comments : '<li class="center">첫번째 댓글을 남겨주세요.</li>'
                );
                var $btnRemoveElements = $('.btn-remove');
                $btnRemoveElements.unbind('click');
                $btnRemoveElements.click(function(e) {
                  e.preventDefault();
                  if (!confirm('정말로 삭제하시겠습니까?')) {
                    return;
                  }
                  var $this = $(this);
                  var lunchId = $this.data('lunch-id');
                  var commentId = $this.data('comment-id');
                  $.ajax({
                    url: '/api/lunches/' + lunchId + '/comments/' + commentId,
                    type: 'DELETE'
                  })
                    .done(function(data) {
                      if (data.success) {
                        initComments(lunchId);
                      } else {
                        alert(data.message || '알 수 없는 오류로 삭제 실패');
                      }
                    })
                    .fail(function() {
                      alert('알 수 없는 오류로 삭제 실패');
                    });
                });
              }
            })
            .fail(function() {
              $commentList.html('<li class="center">댓글을 읽어오는 중에 오류가 발생했습니다.</li>');
            });
        }

        $('.comment-btn-submit').click(function(e) {
          e.preventDefault();
          var lunchId = $commentForm.find('[name="id"]').val();
          var content = $commentForm.find('[name="content"]').val();
          $.ajax({
            url: '/api/lunches/' + lunchId + '/comments',
            type: 'POST',
            data: {
              content: content
            }
          })
            .done(function(data) {
              if (data.success) {
                initComments(lunchId);
              }
            })
            .fail(function() {
              // fail
            });
        });

        $('.btn-comments').click(function(e) {
          e.preventDefault();

          var $this = $(this);
          var id = $this.data('lunch-id');
          initComments(id);

          $('#modal-container')
            .removeAttr('class')
            .addClass('one');
          $('body').addClass('modal-active');
        });

        $('#modal-container').click(function() {
          $(this).addClass('out');
          $('body').removeClass('modal-active');
        });

        $('#modal-content').click(function(e) {
          e.preventDefault();
          e.stopPropagation();
        });

        $('.btn-like').click(function(e) {
          e.preventDefault();
          var $this = $(this);
          var id = $this.data('lunch-id');
          var lunchLikeEl = $('#lunch-like-' + id);
          var like = +lunchLikeEl.text();
          lunchLikeEl.text(like + 1);
          $.ajax({
            url: '/api/lunches/' + id + '/like',
            type: 'PATCH'
          })
            .done(function(data) {
              if (!data.success) {
                lunchLikeEl.text(like);
              }
            })
            .fail(function() {
              lunchLikeEl.text(like);
            });
        });

        $('.btn-dislike').click(function(e) {
          e.preventDefault();
          var $this = $(this);
          var id = $this.data('lunch-id');
          var lunchDisLikeEl = $('#lunch-dislike-' + id);
          var dislike = +lunchDisLikeEl.text();
          lunchDisLikeEl.text(dislike - 1);
          $.ajax({
            url: '/api/lunches/' + id + '/dislike',
            type: 'PATCH'
          })
            .done(function(data) {
              if (!data.success) {
                lunchDisLikeEl.text(dislike);
              }
            })
            .fail(function() {
              lunchDisLikeEl.text(dislike);
            });
        });
      })();
    </script>

    <% include ./templates/footer %>
  </body>
</html>
